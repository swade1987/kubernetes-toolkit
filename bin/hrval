#!/usr/bin/env bash

set -o errexit

# Script locations
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
HRVAL_SCRIPT="${SCRIPT_DIR}/hrval-new.sh"

# Function to check if a file is a HelmRelease
function is_helm_release() {
    local file=$1
    local kind=$(yq r "${file}" kind)
    [[ ${kind} == "HelmRelease" ]] && printf "true" || printf "false"
}

# Function to validate a single file
function validate_file() {
    local file=$1
    local ignore_values=$2
    local helm_version=$3
    local helm_username=$4
    local helm_password=$5
    ${HRVAL_SCRIPT} "${file}" "${ignore_values}" "${helm_version}" "${helm_username}" "${helm_password}"
}

# Function to validate all YAML files in a directory
function validate_directory() {
    local target_path=$1
    local ignore_values=$2
    local helm_version=$3
    local helm_username=$4
    local helm_password=$5

    # Process directory
    target_path=$(printf "%s" "${target_path}" | sed "s/^\///;s/\/$//")

    while IFS= read -r -d '' file; do
        if [[ $(is_helm_release "${file}") == "true" ]]; then
            validate_file "${file}" "${ignore_values}" "${helm_version}" "${helm_username}" "${helm_password}"
            ((files_tested++))
        else
            printf "Ignoring %s: is not a HelmRelease\n" "${file}"
        fi
    done < <(find "${target_path}" -type f \( -name '*.yaml' -o -name '*.yml' \) -print0)
}

# Main function containing the primary logic
function main() {
    local target_path=$1
    local ignore_values=${2:-false}
    local helm_version=${3:-v2}
    local helm_username=${4:-}
    local helm_password=${5:-}

    # Initialize Helm v2 if necessary
    if [[ ${helm_version} == "v2" ]]; then
        helm init --client-only
    fi

    # Determine whether to validate a single file or a directory
    if [[ -f "${target_path}" ]]; then
        validate_file "${target_path}" "${ignore_values}" "${helm_version}" "${helm_username}" "${helm_password}"
    elif [[ -d "${target_path}" ]]; then
        validate_directory "${target_path}" "${ignore_values}" "${helm_version}" "${helm_username}" "${helm_password}"
    else
        printf "Error: %s is neither a file nor a directory!\n" "${target_path}"
        return 1
    fi
}

# Call the main function with all script arguments
main "$@"
